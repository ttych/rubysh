#!/bin/sh
# -*- mode: sh -*-

# set -x


# ### RUBYENV
RUBYENV_ROOT="${RUBYENV_ROOT:-$HOME}"
RUBYENV_ENVS="chruby rbenv ruby-install ruby-build"


# ### git wrappers

git_remote_url()
{
    git_remote_url=$(cd "${1:-.}" ; git remote get-url origin)
}

git_clone()
(
    mkdir -p "${2%/*}"
    git clone -q "$1" "$2"
)

git_update()
(
    if [ -n "$1" ]; then
        cd "$1" || return 1
    fi

    if git rev-parse @{u} >/dev/null 2>&1; then
        git reset --quiet --hard HEAD &&
            git pull --quiet --no-rebase --ff-only
    fi
    git submodule --quiet update --recursive
)

git_clone_or_update()
{
    if [ -d "$2" ]; then
        git_remote_url "$2"
        if [ "$git_remote_url" != "$1" ]; then
            rm -Rf "$2"
        fi
    fi

    if [ ! -d "$2" ]; then
        git_clone "$1" "$2"
    else
        git_update "$2"
    fi
}


# ### rbenv

RBENV_ROOT="${RBENV_ROOT:-$HOME/.rbenv}"
RBENV_ORGA="${RBENV_ORGA:-https://github.com/rbenv}"
RBENV_REPO="${RBENV_REPO:-rbenv}"
RBENV_PLUGINS="${RBENV_PLUGINS:-ruby-build rbenv-vars rbenv-each rbenv-default-gems}"

__rubyenv__rbenv__install_or_update()
{
    git_clone_or_update "${RBENV_ORGA}/${RBENV_REPO}.git" "${RBENV_ROOT}" || return 1
    mkdir -p "${RBENV_ROOT}/plugins" || return 1
    for __rubyenv__rbenv__install_or_update__p in $RBENV_PLUGINS; do
        git_clone_or_update \
            "${RBENV_ORGA}/${__rubyenv__rbenv__install_or_update__p}.git" \
            "${RBENV_ROOT}/plugins/${__rubyenv__rbenv__install_or_update__p}" ||
            return 1
    done
}

__rubyenv__rbenv__status()
{
    [ -d "$RBENV_ROOT" ] &&
        [ -x "$RBENV_ROOT/bin/rbenv" ] &&
        return 0
    return 1
}

__rubyenv__rbenv__list()
{
    echo "rbenv > $RBENV_ROOT > `__rubyenv__rbenv__status && echo installed || echo missing`"
}

__rubyenv__rbenv__install()
{
    __rubyenv__rbenv__status ||
        __rubyenv__rbenv__install_or_update
}

__rubyenv__rbenv__update()
{
    __rubyenv__rbenv__install_or_update
}

__rubyenv__rbenv__init()
{
    cat <<EOF
export RBENV_ROOT="$RBENV_ROOT"
export PATH="$RBENV_ROOT/bin:\$PATH"
eval "\$(rbenv init -)"
EOF
}


# ### ruby-build

RUBY_BUILD_ROOT="${RUBY_BUILD_ROOT:-$HOME/tools/ruby-build}"
RUBY_BUILD_ORGA="${RUBY_BUILD_ORGA:-https://github.com/rbenv}"
RUBY_BUILD_REPO="${RUBY_BUILD_REPO:-ruby-build}"

__rubyenv__ruby_build__install_or_update()
{
    git_clone_or_update "${RUBY_BUILD_ORGA}/${RUBY_BUILD_REPO}.git" "${RUBY_BUILD_ROOT}" || return 1
}

__rubyenv__ruby_build__status()
{
    [ -d "$RUBY_BUILD_ROOT" ] &&
        [ -x "$RUBY_BUILD_ROOT/bin/ruby-build" ] &&
        return 0

    return 1
}

__rubyenv__ruby_build__list()
{
    echo "ruby-build > $RUBY_BUILD_ROOT > `__rubyenv__ruby_build__status && echo installed || echo missing`"
}

__rubyenv__ruby_build__install()
{
    __rubyenv__ruby_build__status ||
        __rubyenv__ruby_build__install_or_update
}

__rubyenv__ruby_build__update()
{
    __rubyenv__ruby_build__install_or_update
}

__rubyenv__ruby_build__init()
{
    cat <<EOF
export PATH="$RUBY_BUILD_ROOT:\$PATH"
EOF
}


# ### chruby
# **** TODO switch / test chruby

# ### ruby-install
# **** ruby-install https://github.com/postmodern/ruby-install#readme



# ### rubyenv

__rubyenv_list()
{
    [ $# -eq 0 ] && set -- $RUBYENV_ENVS

    for __rubyenv_list__i; do
        __rubyenv_list__i="$(echo $__rubyenv_list__i | tr - _)"
        "__rubyenv__${__rubyenv_list__i}__list"
    done
}

__rubyenv_install()
{
    [ $# -eq 0 ] && set -- $RUBYENV_ENVS_

    for __rubyenv_install__i; do
        __rubyenv_install__i="$(echo $__rubyenv_install__i | tr - _)"
        "__rubyenv__${__rubyenv_install__i}__install"
    done
}

__rubyenv_update()
{
    [ $# -eq 0 ] && set -- $RUBYENV_ENVS_

    for __rubyenv_update__i; do
        __rubyenv_update__i="$(echo $__rubyenv_update__i | tr - _)"
        "__rubyenv__${__rubyenv_update__i}__update"
    done
}

__rubyenv_init()
{
    [ $# -eq 0 ] && set -- $RUBYENV_ENVS_

    for __rubyenv_init__i; do
        __rubyenv_init__i="$(echo $__rubyenv_init__i | tr - _)"
        "__rubyenv__${__rubyenv_init__i}__init"
    done
}


__rubyenv_usage()
{
    cat <<EOF
usage is:
    rubyenv [action] [environment]
    rubyenv [environment] [action]

    with action in:
        i|install
        u|update
        I|init
        l|list
    with environment in:
        rbenv
        chruby
        ruby-build
        ruby-install

EOF
}

__rubyenv()
{
    if [ $# -eq 0 ]; then
        __rubyenv_usage
        return 1
    fi

    __rubyenv_action="$( echo $1 | tr - _)"
    shift
    case "$__rubyenv_action" in
        i|install)
            __rubyenv_install "$@" ;;
        u|update)
            __rubyenv_update "$@" ;;
        I|init)
            __rubyenv_init "$@" ;;
        l|list)
            __rubyenv_list "$@" ;;
        *)
            "__rubyenv__${__rubyenv_action}" "$@"
            ;;
    esac
}


# ### main

case "$0" in
    */rubyenv)
        __rubyenv "$@"
        ;;
esac


# ### examples
# rubyenv ruby-build install|update
# rubyenv ruby-install install|update
# rubyenv rbenv install|update|init
# rubyenv chruby install|update|init
#
# rubyenv i|u ruby-build
# rubyenv i|u ruby-install
# rubyenv i|u rbenv
# rubyenv i|u chruby
